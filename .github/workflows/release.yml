name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  # id-token: write  # Required by dd-octo-sts â€” re-enable when org support is added
  packages: write

jobs:
  goreleaser:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: true

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.4'

      - name: Install syft (for SBOM generation)
        uses: anchore/sbom-action/download-syft@v0.22.2

      # TODO: Re-enable dd-octo-sts + homebrew automation when org support is added.
      # For now, homebrew-pack PRs are created manually for each release.
      #
      # - name: Get Homebrew tap token via dd-octo-sts
      #   uses: DataDog/dd-octo-sts-action@acaa02eee7e3bb0839e4272dacb37b8f3b58ba80 # v1.0.3
      #   id: octo-sts
      #   with:
      #     scope: datadog-labs/homebrew-pack
      #     policy: pup-release

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Prepare Homebrew cask update
      #   id: prep-cask
      #   env:
      #     GH_TOKEN: ${{ steps.octo-sts.outputs.token }}
      #   run: |
      #     # Find the generated cask file
      #     CASK_FILE=$(find dist -name "pup.rb" -path "*homebrew*" | head -1)
      #     if [ -z "${CASK_FILE}" ]; then
      #       echo "::error::Generated cask file not found in dist/"
      #       exit 1
      #     fi
      #     echo "cask_file=${CASK_FILE}" >> "$GITHUB_OUTPUT"
      #
      #     # Get current main branch HEAD for branch creation point
      #     MAIN_SHA=$(gh api repos/datadog-labs/homebrew-pack/git/refs/heads/main --jq '.object.sha')
      #     echo "main_sha=${MAIN_SHA}" >> "$GITHUB_OUTPUT"
      #
      #     # Prepare directory structure matching homebrew-pack layout
      #     mkdir -p /tmp/homebrew-update/Casks
      #     cp "${CASK_FILE}" /tmp/homebrew-update/Casks/pup.rb
      #
      # - name: Push signed Homebrew cask update
      #   uses: datadog/commit-headless@action
      #   id: headless-commit
      #   with:
      #     token: ${{ steps.octo-sts.outputs.token }}
      #     target: datadog-labs/homebrew-pack
      #     branch: chore/update-pup-${{ github.ref_name }}
      #     command: commit
      #     working-directory: /tmp/homebrew-update
      #     files: Casks/pup.rb
      #     message: "chore(cask): update pup to ${{ github.ref_name }}"
      #     head-sha: ${{ steps.prep-cask.outputs.main_sha }}
      #     create-branch: true
      #
      # - name: Create PR for Homebrew cask update
      #   env:
      #     GH_TOKEN: ${{ steps.octo-sts.outputs.token }}
      #   run: |
      #     TAG="${GITHUB_REF_NAME}"
      #     gh pr create \
      #       --repo datadog-labs/homebrew-pack \
      #       --title "chore(cask): update pup to ${TAG}" \
      #       --body "$(cat <<EOF
      #     ## Summary
      #     Automated cask update for pup ${TAG}.
      #
      #     - Updates the Homebrew cask formula to the latest release
      #     - Signed commit via [commit-headless](https://github.com/datadog/commit-headless)
      #
      #     ---
      #     Generated by pup release workflow
      #     EOF
      #     )" \
      #       --base main \
      #       --head "chore/update-pup-${TAG}"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/*.txt
            dist/*.sbom.json
            dist/*.sig
            dist/*.pem
          retention-days: 7
