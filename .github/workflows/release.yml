name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-darwin:
    name: Build (${{ matrix.target }})
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        run: |
          rustup toolchain install stable --profile minimal
          rustup default stable
          rustup target add ${{ matrix.target }}
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      - name: Package
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../pup_${{ matrix.target }}.tar.gz pup
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pup_${{ matrix.target }}
          path: pup_${{ matrix.target }}.tar.gz

  build-linux:
    name: Build (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            cross: false
          - target: aarch64-unknown-linux-gnu
            cross: true
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        run: |
          rustup toolchain install stable --profile minimal
          rustup default stable
          rustup target add ${{ matrix.target }}
      - name: Install cross-compilation tools
        if: matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
      - name: Build
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cargo build --release --target ${{ matrix.target }} --features vendored-openssl
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
      - name: Package
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../pup_${{ matrix.target }}.tar.gz pup
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pup_${{ matrix.target }}
          path: pup_${{ matrix.target }}.tar.gz

  build-wasm:
    name: Build (WASM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        run: |
          rustup toolchain install stable --profile minimal
          rustup default stable
          rustup target add wasm32-wasip2 wasm32-unknown-unknown
      - name: Build WASI
        run: cargo build --release --target wasm32-wasip2 --no-default-features --features wasi
      - name: Package WASI
        run: |
          cp target/wasm32-wasip2/release/pup.wasm pup_wasi.wasm
          tar czf pup_wasm32-wasip2.tar.gz pup_wasi.wasm
      - name: Install wasm-pack
        run: cargo install wasm-pack
      - name: Build browser WASM
        run: wasm-pack build --target web --no-default-features --features browser
      - name: Package browser WASM
        run: tar czf pup_browser-wasm.tar.gz -C pkg .
      - name: Upload WASI artifact
        uses: actions/upload-artifact@v4
        with:
          name: pup_wasm32-wasip2
          path: pup_wasm32-wasip2.tar.gz
      - name: Upload browser WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: pup_browser-wasm
          path: pup_browser-wasm.tar.gz

  release:
    name: Create Release
    needs: [build-darwin, build-linux, build-wasm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare release assets
        id: prep
        run: |
          mkdir -p release
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          # Rename archives to match release naming convention
          cp "artifacts/pup_x86_64-apple-darwin/pup_x86_64-apple-darwin.tar.gz" \
             "release/pup_${VERSION}_Darwin_x86_64.tar.gz"
          cp "artifacts/pup_aarch64-apple-darwin/pup_aarch64-apple-darwin.tar.gz" \
             "release/pup_${VERSION}_Darwin_arm64.tar.gz"
          cp "artifacts/pup_x86_64-unknown-linux-gnu/pup_x86_64-unknown-linux-gnu.tar.gz" \
             "release/pup_${VERSION}_Linux_x86_64.tar.gz"
          cp "artifacts/pup_aarch64-unknown-linux-gnu/pup_aarch64-unknown-linux-gnu.tar.gz" \
             "release/pup_${VERSION}_Linux_arm64.tar.gz"
          cp "artifacts/pup_wasm32-wasip2/pup_wasm32-wasip2.tar.gz" \
             "release/pup_${VERSION}_WASI.tar.gz"
          cp "artifacts/pup_browser-wasm/pup_browser-wasm.tar.gz" \
             "release/pup_${VERSION}_Browser_WASM.tar.gz"

          # Generate checksums
          cd release
          sha256sum -- *.tar.gz > "pup_${VERSION}_checksums.txt"
          cat "pup_${VERSION}_checksums.txt"
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.prep.outputs.version }}
          TAG: ${{ github.ref_name }}
        run: |
          gh release create "${TAG}" ./release/* \
            --title "Release ${VERSION}" \
            --generate-notes
