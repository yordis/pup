name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write  # Required for cosign keyless signing

jobs:
  goreleaser:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Fetch all tags
        run: git fetch --force --tags
      - name: Install Zig
        run: |
          ZIG_VERSION="0.13.0"
          curl -sL "https://ziglang.org/download/${ZIG_VERSION}/zig-macos-aarch64-${ZIG_VERSION}.tar.xz" | tar xJ
          echo "$PWD/zig-macos-aarch64-${ZIG_VERSION}" >> "$GITHUB_PATH"
      - name: Install Rust
        run: |
          rustup toolchain install stable --profile minimal
          rustup default stable
      - name: Install cosign
        uses: sigstore/cosign-installer@v3
      - name: Install syft
        uses: anchore/sbom-action/download-syft@v0
      - uses: goreleaser/goreleaser-action@v7
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --parallelism 4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
